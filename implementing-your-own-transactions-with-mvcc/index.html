<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="XNERV SURVEYS" type="application/atom+xml">
  <meta name="google-site-verification" content="google819a2e66056c8144">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: 'VK1UJWKNY9',
      apiKey: '7b99451966536b0cd610a773068159a0',
      indexName: 'xnerv.wang',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="This article is part of a series. You do not have to read them in order but I will be referring to topics and explanations in previous articles:  Implementing Your Own Transactions With MVCC SQL Trans">
<meta property="og:type" content="article">
<meta property="og:title" content="IMPLEMENTING YOUR OWN TRANSACTIONS WITH MVCC（转载）">
<meta property="og:url" content="https://xnerv.wang/implementing-your-own-transactions-with-mvcc/index.html">
<meta property="og:site_name" content="XNERV SURVEYS">
<meta property="og:description" content="This article is part of a series. You do not have to read them in order but I will be referring to topics and explanations in previous articles:  Implementing Your Own Transactions With MVCC SQL Trans">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://postachio-images.s3.amazonaws.com/aa0e0e8e-5932-48c5-bbd5-bb782bc5caef/34bf5c8b-35b7-4768-944c-7baf3acce0d5/3c68b122-cc0d-4461-ade6-fae0d9594095.png">
<meta property="article:published_time" content="2018-01-30T06:21:00.000Z">
<meta property="article:modified_time" content="2023-08-21T02:24:18.737Z">
<meta property="article:author" content="Xnerv Wang (xnervwang)">
<meta property="article:tag" content="转载">
<meta property="article:tag" content="DBMS">
<meta property="article:tag" content="MVCC">
<meta property="article:tag" content="SQL Server">
<meta property="article:tag" content="Transaction">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://postachio-images.s3.amazonaws.com/aa0e0e8e-5932-48c5-bbd5-bb782bc5caef/34bf5c8b-35b7-4768-944c-7baf3acce0d5/3c68b122-cc0d-4461-ade6-fae0d9594095.png">

<link rel="canonical" href="https://xnerv.wang/implementing-your-own-transactions-with-mvcc/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/social-share.js@1/dist/js/social-share.min.css">
  <title>IMPLEMENTING YOUR OWN TRANSACTIONS WITH MVCC（转载） | XNERV SURVEYS</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90038341-1"></script>
    <script>
      var host = window.location.hostname;
      if (host !== "localhost" || !true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-90038341-1');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?fa4c42961138739a56782aee8127449f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <!--a href="https://github.com/xnervwang" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="/assets/forkme.png" alt="Fork me on GitHub" data-canonical-src="/assets/forkme_right_darkblue.png"></a-->
    <a target="_blank" rel="noopener" href="https://github.com/xnervwang" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">XNERV SURVEYS</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">God's in his heaven.<br/>All's right with the world.</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-leetcode">

    <a href="https://leetcode.xnerv.wang/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>LeetCode</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xnerv.wang/implementing-your-own-transactions-with-mvcc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/portraits/nerv.png">
      <meta itemprop="name" content="Xnerv Wang (xnervwang)">
      <meta itemprop="description" content="Xnerv Wang (xnervwang) 的技术博客，主要涉及C/C++、数据库引擎开发、文件系统、TCP/IP与网络、分布式系统和Linux等领域，也会偶尔刷一刷LeetCode等题库。毕业于南京大学软件学院，曾经在腾讯、百度、微软上海等大型互联网企业工作，目前奋斗在微软西雅图，从事Azure上的MySQL/PostgreSQL开源数据库云服务开发。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XNERV SURVEYS">
    </span>
      <header class="post-header">

        <h2 class="post-title" itemprop="name headline">
          IMPLEMENTING YOUR OWN TRANSACTIONS WITH MVCC（转载）
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-01-29 22:21:00" itemprop="dateCreated datePublished" datetime="2018-01-29T22:21:00-08:00">2018-01-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DBMS/" itemprop="url" rel="index">
                    <span itemprop="name">DBMS</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>This article is part of a series. You do not have to read them in order but I will be referring to topics and explanations in previous articles:</p>
<ol>
<li><strong>Implementing Your Own Transactions With MVCC</strong></li>
<li><a href="/sql-transaction-isolation-levels-explained">SQL Transaction Isolation Levels Explained</a></li>
<li><a href="/implementing-repeatable-read-and-serializable-transaction-isolation">Implementing Repeatable Read and Serializable Transaction Isolation</a></li>
</ol>
<a id="more"></a>
<hr>
<p><img src="http://postachio-images.s3.amazonaws.com/aa0e0e8e-5932-48c5-bbd5-bb782bc5caef/34bf5c8b-35b7-4768-944c-7baf3acce0d5/3c68b122-cc0d-4461-ade6-fae0d9594095.png" alt=""></p>
<p>MVCC (<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Multiversion_concurrency_control">MultiVersion Concurrency Control</a>) is a simple and effective way to implement transactional isolation with any application managing a group of things. We usually think of these things as database records by they could be anything really.</p>
<p>MVCC is one of the most widely implemented concurrency control algorithms because reads do not block other reads and writes do not block other reads or writes. This means that we can safely and concurrently have lots of clients reading and writing simultaneously without blocking each other. With some notable specific cases that I will explain later.</p>
<h2 id="What-is-Isolation"><a class="header-anchor" href="#What-is-Isolation"></a>What is Isolation?</h2>
<p>Isolation (the I from <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/ACID">ACID</a>) makes sure that when a client begins a transaction that the data it sees will always be the same. Event if other clients are modifying the data.</p>
<p>If another client (or clients);</p>
<ul>
<li><strong>Add a record</strong>: It will not be visible to you.</li>
<li><strong>Delete a record</strong>: It will remain visible to you.</li>
<li><strong>Modify a record</strong>: You will forever see the version before it was changed.</li>
</ul>
<p>However, inside your transaction those three things do to take affect. So if you add a record then it will be visible to you.</p>
<p>Often overlooked, transactions applied to the correct applications can;</p>
<ul>
<li><strong>Alleviate blocking</strong> if you previously relied on simply locking the whole database until your modifications where finished.</li>
<li><strong>Prevent read issues from arising</strong> if your application is affected by reading the same data twice and getting two different answers unexpectedly.</li>
<li><strong>Provide durability</strong>. At any time you can throw away the changes if you change your mind without explicitly undoing all the changes yourself.</li>
</ul>
<h2 id="Terminology"><a class="header-anchor" href="#Terminology"></a>Terminology</h2>
<p>A <em>record</em> is a single entity. This would be best explained as a database record. It could also be a file, a JSON object, anything that encapsulates something. Most importantly here is that a record cannot be simultaneously modified by two separate clients. If you have a complex data structure you will want to make sure what you define as a record does not encapsulate too much.</p>
<p>A <em>collection</em> is the set of records. This would be like a table in a database. The important thing here is that a transaction is not isolated to a single collection as long as each of the records share the same transaction IDs.</p>
<p>A <em>transaction ID</em> (also called an <em>XID</em>) is the unique number for the transaction. All records that have been modified under the same transaction can be saved or rolled back as one atomic operation, which is ultimately what we want.</p>
<h2 id="Transaction-IDs"><a class="header-anchor" href="#Transaction-IDs"></a>Transaction IDs</h2>
<p>There are three categories of transaction ID numbering systems we can use;</p>
<ol>
<li><strong>An incrementing number.</strong> Before a transaction starts (before any changes occur is important, even if there are no changes). This is the transaction ID for all the record changes. It doesn’t matter if the changes are saved or thrown away the same transaction ID can never be used again so it must be atomic. Also important is the value must be kept when the script/server restarts to prevent transaction IDs from being reused.</li>
<li><strong>A timestamp.</strong> We do not need to maintain an atomic counter. This has the added benefit of allowing us to restore the collections to some point in time. There is one caveat; if the timestamp does not have a high enough resolution (lets say your using whole seconds) transactions that start very close to each other would potentially share the same transaction ID and horrible things will happen…</li>
<li><strong>Custom transaction ID implementations</strong>. Special cases where you are working with distributed databases or have other requirements that are not satisfied by the two types above. This may include UUID based algorithms and may not even be strictly a number.</li>
</ol>
<p>Items 2 and 3 each deserve their own blog post so we won’t walk about it here. Just the mechanism of the most simple implementation of using an incrementing counter.</p>
<h2 id="It’s-Time-to-Dive-In"><a class="header-anchor" href="#It’s-Time-to-Dive-In"></a>It’s Time to Dive In</h2>
<p>I’m going to provide the code examples in Python. The full example program is available <a target="_blank" rel="noopener" href="https://gist.github.com/elliotchance/d169e39f5d4d056a9138">in this gist</a>. But I will explain each piece below.</p>
<p>In a nutshell what we need is the next transaction ID and an array (or set) of the transactions currently active to produce new transactions:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">next_xid = <span class="number">1</span></span><br><span class="line">active_xids = set()</span><br><span class="line">records = []</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_transaction</span>():</span></span><br><span class="line">    <span class="keyword">global</span> next_xid</span><br><span class="line">    next_xid += <span class="number">1</span></span><br><span class="line">    active_xids.add(next_xid)</span><br><span class="line">    <span class="keyword">return</span> Transaction(next_xid)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Transaction</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, xid</span>):</span></span><br><span class="line">        self.xid = xid</span><br><span class="line">        self.rollback_actions = []</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>In your application you may decide that clients (if you have any) can control when transactions are opened or closed. It doesn’t affect how the transactions work and they are independent of this.</p>
<p>Next we need to add two discreet pieces of information attached to each record. Called the created XID and expired XID. It’s best to store these directly with the record itself. However, that is not always possible so you can maintain them somewhere external as long as you are the only one modifying the data to maintain consistency.</p>
<h2 id="Row-Visibility-and-Locking"><a class="header-anchor" href="#Row-Visibility-and-Locking"></a>Row Visibility and Locking</h2>
<p>Ultimately this is what MVCC comes down to: The visibility of a row depending on who is looking at it. Ever row has to be tested if it is visible to the client looking at it:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#class Transaction:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">record_is_visible</span>(<span class="params">self, record</span>):</span></span><br><span class="line">        <span class="comment"># The record was created in active transaction that is not our</span></span><br><span class="line">        <span class="comment"># own.</span></span><br><span class="line">        <span class="keyword">if</span> record[<span class="string">&#x27;created_xid&#x27;</span>] <span class="keyword">in</span> active_xids <span class="keyword">and</span> \</span><br><span class="line">            record[<span class="string">&#x27;created_xid&#x27;</span>] != self.xid:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># The record is expired or and no transaction holds it that is</span></span><br><span class="line">        <span class="comment"># our own.</span></span><br><span class="line">        <span class="keyword">if</span> record[<span class="string">&#x27;expired_xid&#x27;</span>] != <span class="number">0</span> <span class="keyword">and</span> \</span><br><span class="line">            (record[<span class="string">&#x27;expired_xid&#x27;</span>] <span class="keyword">not</span> <span class="keyword">in</span> active_xids <span class="keyword">or</span> \</span><br><span class="line">            record[<span class="string">&#x27;expired_xid&#x27;</span>] == self.xid):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(xnerv: created_id is the transaction ID which created this row. expired_id is the transaction ID which deleted this row.)</p>
<p>Furthermore, we discussed before that simultaneous transactions cannot make a modification to the same record. If this happens there are two ways to handle this:</p>
<ol>
<li><strong>Abort (rollback)</strong> the transaction that tried to make the most recent changes and propagate the error back to the original client.</li>
<li><strong>Wait (block)</strong> the second transaction until that record becomes available. This has some special challenges with performance and potential reread errors.</li>
</ol>
<p>The safest and easiest one is the first choice - so that’s what we’re going to use in this tutorial. When we do need to modify a record we need to check if it is locked by another transaction with this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#class Transaction:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">row_is_locked</span>(<span class="params">self, record</span>):</span></span><br><span class="line">        <span class="keyword">return</span> record[<span class="string">&#x27;expired_xid&#x27;</span>] != <span class="number">0</span> <span class="keyword">and</span> \</span><br><span class="line">            record[<span class="string">&#x27;expired_xid&#x27;</span>] <span class="keyword">in</span> active_xids</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Adding-a-Record"><a class="header-anchor" href="#Adding-a-Record"></a>Adding a Record</h2>
<p>This is an easy one. We set the  created_xid  to the current transaction ID and  expired_xid  to  0 :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#class Transaction:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_record</span>(<span class="params">self, record</span>):</span></span><br><span class="line">        record[<span class="string">&#x27;created_xid&#x27;</span>] = self.xid</span><br><span class="line">        record[<span class="string">&#x27;expired_xid&#x27;</span>] = <span class="number">0</span></span><br><span class="line">        self.rollback_actions.append([<span class="string">&quot;delete&quot;</span>, len(records)])</span><br><span class="line">        records.append(record)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The <code>rollback_actions</code> will be explained later.</p>
<h2 id="Deleting-a-Record"><a class="header-anchor" href="#Deleting-a-Record"></a>Deleting a Record</h2>
<p>There are two possibilities:</p>
<ol>
<li>The <code>expired_xid</code> is <code>0</code> meaning the record has never been deleted by anyone. So by setting <code>expired_xid</code> to the current transaction ID we are marking it as deleted.</li>
<li>The <code>expired_xid</code> it not <code>0</code> <em>and</em> <code>expired_xid</code> is an active transaction. The record has been deleted by another active transaction and so we cannot touch it.</li>
</ol>
<p>The third scenario where <code>expired_xid</code> is not an active transaction is not possible due to the normal visibility constraints.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#class Transaction:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete_record</span>(<span class="params">self, id</span>):</span></span><br><span class="line">        <span class="keyword">for</span> i, record <span class="keyword">in</span> enumerate(records):</span><br><span class="line">            <span class="keyword">if</span> self.record_is_visible(record) <span class="keyword">and</span> record[<span class="string">&#x27;id&#x27;</span>] == id:</span><br><span class="line">                <span class="keyword">if</span> self.row_is_locked(record):</span><br><span class="line">                    <span class="keyword">raise</span> Error(<span class="string">&quot;Row locked by another transaction.&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    record[<span class="string">&#x27;expired_xid&#x27;</span>] = self.xid</span><br><span class="line">                    self.rollback_actions.append([<span class="string">&quot;add&quot;</span>, i])</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The <code>rollback_actions</code> will be explained later.</p>
<h2 id="Updating-a-Record"><a class="header-anchor" href="#Updating-a-Record"></a>Updating a Record</h2>
<p>Updating is a combination of deleting the old one and adding a new one. This allows the existing record to still be viewed by other transactions. If the <code>delete_record</code> fails then the exception raised would cause the subsequent <code>add_record</code> not to happen which is what we want.</p>
<p>(xnerv: Absolutely this implementation is different from popular DBMS like MySQL.)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#class Transaction:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_record</span>(<span class="params">self, id, name</span>):</span></span><br><span class="line">        self.delete_record(id)</span><br><span class="line">        self.add_record(&#123;<span class="string">&quot;id&quot;</span>: id, <span class="string">&quot;name&quot;</span>: name&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Committing-Changes"><a class="header-anchor" href="#Committing-Changes"></a>Committing Changes</h2>
<p>Once all the modifications have been made we need to <em>commit</em> all the changes so that future clients can see these new changes. Very easy, we simply remove our transaction ID from the active list of transactions:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#class Transaction:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">commit</span>(<span class="params">self</span>):</span></span><br><span class="line">        active_xids.discard(self.xid)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Rollback-Changes"><a class="header-anchor" href="#Rollback-Changes"></a>Rollback Changes</h2>
<p>Rolling back can be done several ways, one way is to replay the changes in reverse:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#class Transaction:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">rollback</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">for</span> action <span class="keyword">in</span> reversed(self.rollback_actions):</span><br><span class="line">            <span class="keyword">if</span> action[<span class="number">0</span>] == <span class="string">&#x27;add&#x27;</span>:</span><br><span class="line">                records[action[<span class="number">1</span>]][<span class="string">&#x27;expired_xid&#x27;</span>] = <span class="number">0</span></span><br><span class="line">            <span class="keyword">elif</span> action[<span class="number">0</span>] == <span class="string">&#x27;delete&#x27;</span>:</span><br><span class="line">                records[action[<span class="number">1</span>]][<span class="string">&#x27;expired_xid&#x27;</span>] = self.xid</span><br><span class="line"></span><br><span class="line">        active_xids.discard(self.xid)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Note: This is fine for an environment where the server can guarantee that the all rollback actions will be replayed and that when the server is shut down forcefully that all the active transactions will have <code>rollback()</code> invoked on them.</p>
<p>If you want higher durability that can recover from a server randomly crashing you will need to keep the transaction ID stored somewhere atomically and have extra code on the server start up that checks to see if it was shutdown safely, and manually repairs the records if need be. I will not go into this as this article is already long enough, but it may be explained in a future article.</p>
<h2 id="Vacuuming-or-Reclaiming-Space"><a class="header-anchor" href="#Vacuuming-or-Reclaiming-Space"></a>Vacuuming or Reclaiming Space</h2>
<p>You have probably noticed with this algorithm is that it does not ever actually delete data, only mark it as deleted. This makes it fantastic for keeping lots of records on disk by only appending to the file for modifications.</p>
<p>Overtime you will likely want to gain back all that dead space. If it’s in a memory database you could simply iterate through the records and permanently delete the records that are now fully dead.</p>
<p>If your using a medium like the disk this isn’t so easy. If your application isn’t too complicated you may be able to rewrite all of the non-dead rows out to a new file and switch it underneath your server. There are tons of solutions for this that aren’t specific to how MVCC works so I’ll leave that up to you.</p>
<p>In any case we need to be sensitive to row visibility here as well. Records that have an <code>expired_xid</code> that is not <code>0</code> <em>and</em> it does not appear in the active transactions are fully dead rows.</p>
<hr>
<p><strong>本文地址：<a href="http://xnerv.wang/implementing-your-own-transactions-with-mvcc/">http://xnerv.wang/implementing-your-own-transactions-with-mvcc/</a></strong><br>
转载自：<a target="_blank" rel="noopener" href="http://elliot.land/post/implementing-your-own-transactions-with-mvcc">IMPLEMENTING YOUR OWN TRANSACTIONS WITH MVCC</a></p>

    </div>

    
    
    <div class="post-widgets">
    <div
      class="social-share"
      
        data-sites="weibo,qq,wechat,tencent,douban,qzone,linkedin,diandian,facebook,twitter,google"
      
      
        data-wechat-qrcode-title="分享这篇文章"
      
      
        data-wechat-qrcode-helper="请扫描二维码"
      
    >
    </div>
  </div>
  <script src="//cdn.jsdelivr.net/npm/social-share.js@1/dist/js/social-share.min.js"></script>

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag"># 转载</a>
              <a href="/tags/DBMS/" rel="tag"># DBMS</a>
              <a href="/tags/MVCC/" rel="tag"># MVCC</a>
              <a href="/tags/SQL-Server/" rel="tag"># SQL Server</a>
              <a href="/tags/Transaction/" rel="tag"># Transaction</a>
          </div>

        

      </footer>
    
  </article>
  
  
  

  </div>

  <!--hr/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- xnerv.wang bottom ad -->
    <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-5173793122443057"
        data-ad-slot="1774750366"
        data-ad-format="auto"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  <hr/-->


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#What-is-Isolation"><span class="nav-text">What is Isolation?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Terminology"><span class="nav-text">Terminology</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Transaction-IDs"><span class="nav-text">Transaction IDs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#It%E2%80%99s-Time-to-Dive-In"><span class="nav-text">It’s Time to Dive In</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Row-Visibility-and-Locking"><span class="nav-text">Row Visibility and Locking</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Adding-a-Record"><span class="nav-text">Adding a Record</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Deleting-a-Record"><span class="nav-text">Deleting a Record</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Updating-a-Record"><span class="nav-text">Updating a Record</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Committing-Changes"><span class="nav-text">Committing Changes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Rollback-Changes"><span class="nav-text">Rollback Changes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vacuuming-or-Reclaiming-Space"><span class="nav-text">Vacuuming or Reclaiming Space</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Xnerv Wang (xnervwang)"
      src="/portraits/nerv.png">
  <p class="site-author-name" itemprop="name">Xnerv Wang (xnervwang)</p>
  <div class="site-description" itemprop="description">Xnerv Wang (xnervwang) 的技术博客，主要涉及C/C++、数据库引擎开发、文件系统、TCP/IP与网络、分布式系统和Linux等领域，也会偶尔刷一刷LeetCode等题库。毕业于南京大学软件学院，曾经在腾讯、百度、微软上海等大型互联网企业工作，目前奋斗在微软西雅图，从事Azure上的MySQL/PostgreSQL开源数据库云服务开发。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">122</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">167</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2008 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-eye"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xnerv Wang (xnervwang)</span>
</div>

<div>
  <span>God's in his heaven. All's right with the world.</span>
</div>

        








  <script>
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=60335024";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  <script>
    var _mtac = {};
    (function() {
      var mta = document.createElement("script");
      mta.src = "https://pingjs.qq.com/h5/stats.js";
      mta.setAttribute("name", "MTAH5");
      mta.setAttribute("sid", "60335024");
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(mta, s);
    })();
  </script>


        
      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  
<script src="/js/local-search.js"></script>














  

  

  


  <!-- baidu tuijian -->
  <div id="hm_t_123"></div>
</body>
</html>
