<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="XNERV SURVEYS" type="application/atom+xml">
  <meta name="google-site-verification" content="google819a2e66056c8144">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: 'VK1UJWKNY9',
      apiKey: '7b99451966536b0cd610a773068159a0',
      indexName: 'xnerv.wang',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="SQL Server provides two physical implementations of the read committed isolation level defined by the SQL standard, locking read committed and read committed snapshot isolation (RCSI). While both impl">
<meta property="og:type" content="article">
<meta property="og:title" content="Read Committed Snapshot Isolation（转载）">
<meta property="og:url" content="https://xnerv.wang/read-committed-snapshot-isolation/index.html">
<meta property="og:site_name" content="XNERV SURVEYS">
<meta property="og:description" content="SQL Server provides two physical implementations of the read committed isolation level defined by the SQL standard, locking read committed and read committed snapshot isolation (RCSI). While both impl">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xnerv.wang/assets/read-committed-snapshot-isolation/1.png">
<meta property="article:published_time" content="2018-01-30T07:47:00.000Z">
<meta property="article:modified_time" content="2023-08-21T03:06:05.696Z">
<meta property="article:author" content="Xnerv Wang (xnervwang)">
<meta property="article:tag" content="转载">
<meta property="article:tag" content="DBMS">
<meta property="article:tag" content="SQL Server">
<meta property="article:tag" content="Transaction">
<meta property="article:tag" content="Isolation Level">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xnerv.wang/assets/read-committed-snapshot-isolation/1.png">

<link rel="canonical" href="https://xnerv.wang/read-committed-snapshot-isolation/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/social-share.js@1/dist/js/social-share.min.css">
  <title>Read Committed Snapshot Isolation（转载） | XNERV SURVEYS</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90038341-1"></script>
    <script>
      var host = window.location.hostname;
      if (host !== "localhost" || !true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-90038341-1');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?fa4c42961138739a56782aee8127449f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <!--a href="https://github.com/xnervwang" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="/assets/forkme.png" alt="Fork me on GitHub" data-canonical-src="/assets/forkme_right_darkblue.png"></a-->
    <a target="_blank" rel="noopener" href="https://github.com/xnervwang" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">XNERV SURVEYS</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">God's in his heaven.<br/>All's right with the world.</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-leetcode">

    <a href="https://leetcode.xnerv.wang/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>LeetCode</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xnerv.wang/read-committed-snapshot-isolation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/portraits/nerv.png">
      <meta itemprop="name" content="Xnerv Wang (xnervwang)">
      <meta itemprop="description" content="Xnerv Wang (xnervwang) 的技术博客，主要涉及C/C++、数据库引擎开发、文件系统、TCP/IP与网络、分布式系统和Linux等领域，也会偶尔刷一刷LeetCode等题库。毕业于南京大学软件学院，曾经在腾讯、百度、微软上海等大型互联网企业工作，目前奋斗在微软西雅图，从事Azure上的MySQL/PostgreSQL开源数据库云服务开发。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XNERV SURVEYS">
    </span>
      <header class="post-header">

        <h2 class="post-title" itemprop="name headline">
          Read Committed Snapshot Isolation（转载）
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-01-29 23:47:00" itemprop="dateCreated datePublished" datetime="2018-01-29T23:47:00-08:00">2018-01-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DBMS/" itemprop="url" rel="index">
                    <span itemprop="name">DBMS</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>SQL Server provides two physical implementations of the <strong>read committed</strong> isolation level defined by the SQL standard, locking read committed and read committed snapshot isolation (<strong>RCSI</strong>). While both implementations meet the requirements laid down in the SQL standard for read committed isolation behaviours, RCSI has quite different physical behaviours from the locking implementation we looked at in <a href="/2014/04/t-sql-queries/the-read-committed-isolation-level">the previous post in this series</a>.</p>
<span id="more"></span>
<h2 id="Logical-Guarantees"><a class="header-anchor" href="#Logical-Guarantees"></a>Logical Guarantees</h2>
<p>The SQL standard requires that a transaction operating at the read committed isolation level not experience any dirty reads. Another way to express this requirement is to say a read committed transaction <strong>must only encounter committed data</strong>.</p>
<p>The standard also says that read committed transactions <strong>might</strong> experience the concurrency phenomena known as non-repeatable reads and phantoms (though they are not actually required to do so). As it happens, both physical implementations of read committed isolation in SQL Server can experience non-repeatable reads and phantom rows, though the precise details are quite different.</p>
<h2 id="A-point-in-time-view-of-committed-data"><a class="header-anchor" href="#A-point-in-time-view-of-committed-data"></a>A point-in-time view of committed data</h2>
<p>If the database option <code>READ_COMMITTED_SNAPSHOT</code> in <code>ON</code>, SQL Server uses a <a target="_blank" rel="noopener" href="http://msdn.microsoft.com/en-us/library/ms177404.aspx">row-versioning implementation</a> of the read committed isolation level. When this is enabled, transactions requesting read committed isolation automatically use the RCSI implementation; no changes to existing T-SQL code is required to use RCSI. Note carefully though that this is <strong>not the same</strong> as saying that code <strong>will behave the same</strong> under RCSI as when using the locking implementation of read committed, in fact this is quite generally <strong>not the case</strong>.</p>
<p>There is nothing in the SQL standard that requires the data read by a read committed transaction to be the <strong>most-recently</strong> committed data. The SQL Server RCSI implementation takes advantage of this to provide transactions with a <strong>point-in-time view</strong> of committed data, where that point in time is the moment the <strong>current statement began</strong> execution (not the moment any containing transaction started).</p>
<p>This is quite different from the behaviour of the SQL Server locking implementation of read committed, where the statement sees the most-recently committed data as of <strong>the moment each item is physically read</strong>. Locking read committed releases shared locks as quickly as possible, so the set of data encountered may come from very different points in time.</p>
<p>To summarize, locking read committed sees <strong>each row</strong> as it was at the time it was briefly locked and physically read; RCSI sees <strong>all rows</strong> as they were at the time the statement began. Both implementations are guaranteed to never see uncommitted data, but the data they encounter can be very different.</p>
<h3 id="The-implications-of-a-point-in-time-view"><a class="header-anchor" href="#The-implications-of-a-point-in-time-view"></a>The implications of a point-in-time view</h3>
<p>Seeing a point-in-time view of committed data might seem self-evidently superior to the more complex behaviour of the locking implementation. It is clear, for example, that a point-in-time view cannot suffer from the problems of <strong>missing rows</strong> or encountering the <strong>same row multiple times</strong>, which are both possible under locking read committed isolation.</p>
<p>A second important advantage of RCSI is that it <strong>does not acquire shared locks</strong> when reading data, because the data comes from the row version store rather than being accessed directly. The lack of shared locks can dramatically <strong>improve concurrency</strong> by eliminating conflicts with concurrent transactions looking to acquire incompatible locks. This advantage is commonly summarized by saying that readers do not block writers under RCSI, and vice-versa. As a further consequence of reducing blocking due to incompatible lock requests, the opportunity for <strong>deadlocks</strong> is usually greatly reduced when running under RCSI.</p>
<p>However, these benefits do not come without <strong>costs and caveats</strong>. For one thing, maintaining versions of committed rows consumes system resources, so it is important that the physical environment is configured to cope with this, primarily in terms of <em>tempdb</em> performance and memory/disk space requirements.</p>
<p>The second caveat is a little more subtle: RCSI provides a snapshot view of committed data <strong>as it was</strong> at the start of the statement, but there is nothing to prevent the real data from being changed (and those changes committed) while the RCSI statement is executing. There are no shared locks, remember. An immediate consequence of this second point is that T-SQL code running under RCSI might <strong>make decisions based on out of date information</strong>, as compared with the current committed state of the database. We will talk more about this shortly.</p>
<p>There is one last (implementation-specific) observation I want to make about RCSI before we move on. <strong>Scalar and multi-statement functions</strong> execute using a different internal T-SQL context from the containing statement. This means that the point-in-time view seen inside a scalar or multi-statement function invocation can be later than the point-in-time view seen by the rest of the statement. This can result in unexpected inconsistencies, as different parts of the same statement see <strong>data from different points in time</strong>. This weird and confusing behaviour does <strong>not</strong> apply to in-line functions, which see the same snapshot as the statement they appear in.</p>
<h3 id="Non-repeatable-reads-and-phantoms"><a class="header-anchor" href="#Non-repeatable-reads-and-phantoms"></a>Non-repeatable reads and phantoms</h3>
<p>Given a statement-level point-in-time view of the committed state of the database, it might not be immediately apparent how a read committed transaction under RCSI might experience the non-repeatable read or phantom row phenomena. Indeed, if we limit our thinking to the scope of a <strong>single statement</strong>, neither of these phenomena are possible under RCSI.</p>
<p>Reading the same data multiple times within the <strong>same statement</strong> under RCSI will always return the same data values, no data will disappear between those reads, and no new data will appear either. If you are wondering what sort of statement might read the same data more than once, think about queries that reference the same table more than once, perhaps in a subquery.</p>
<p>Statement-level read consistency is an obvious consequence of the reads being issued against a fixed snapshot of the data. The reason that RCSI does <strong>not</strong> provide protection from non-repeatable reads and phantoms is that these SQL standard phenomena are defined at the transaction level. Multiple statements within a transaction running at RCSI may see different data, because each statement sees a point-in-time view as of the moment <strong>that particular statement</strong> started.</p>
<p>To summarize, each <strong>statement</strong> within an RCSI transaction sees a static committed data set, but that set can change between statements inside the same transaction.</p>
<h2 id="Out-of-date-data"><a class="header-anchor" href="#Out-of-date-data"></a>Out-of-date data</h2>
<p>The possibility of our T-SQL code making an important decision based on out-of-date information is more than a little unsettling. Consider for a moment that the point-in-time snapshot used by a single statement running under RCSI might be <strong>arbitrarily old</strong>.</p>
<p>A statement that runs for a considerable period a time will continue to see the committed state of the database as it was when the statement began. Meanwhile, the statement is missing all the committed changes that occurred in the database since that time.</p>
<p>This is not to say that problems associated with accessing stale data under RCSI are limited to <strong>long-running</strong> statements, but the issues certainly might be more pronounced in such cases.</p>
<h3 id="A-question-of-timing"><a class="header-anchor" href="#A-question-of-timing"></a>A question of timing</h3>
<p>This issue of out-of-date data applies to all RCSI statements in principle, no matter how quickly they might complete. How ever small the time window is, there is always a chance that a concurrent operation might modify the data set we are working with, without us being aware of that change. Let us look again at one of the simple examples we used before when exploring the behaviour of locking read committed:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> dbo.OverdueInvoices</span><br><span class="line"><span class="keyword">SELECT</span> I.InvoiceNumber</span><br><span class="line"><span class="keyword">FROM</span> dbo.Invoices <span class="keyword">AS</span> I</span><br><span class="line"><span class="keyword">WHERE</span> I.TotalDue <span class="operator">&gt;</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">SUM</span>(P.Amount)</span><br><span class="line">    <span class="keyword">FROM</span> dbo.Payments <span class="keyword">AS</span> P</span><br><span class="line">    <span class="keyword">WHERE</span> P.InvoiceNumber <span class="operator">=</span> I.InvoiceNumber</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>When run under RCSI, this statement <strong>cannot</strong> see any committed database modifications that occur after the statement starts executing. While we will not encounter the problems of missed or multiply-encountered rows possible under the locking implementation, a concurrent transaction might add a payment that <strong>ought</strong> to prevent a customer from being sent a stern warning letter about an overdue payment after the statement above starts executing.</p>
<p>You can probably think of many other potential problems that might occur in this scenario, or in others that are conceptually similar. The longer the statement runs for, the more out-of-date its view of the database becomes, and the greater the scope for possibly-unintended consequences.</p>
<p>Of course, there are plenty of mitigating factors in this specific example. The behaviour might well be seen as perfectly acceptable. After all, sending a reminder letter because a payment arrived a few seconds too late is an easily defended action. The principle remains however.</p>
<h3 id="Business-Rule-Failures-and-Integrity-Risks"><a class="header-anchor" href="#Business-Rule-Failures-and-Integrity-Risks"></a>Business Rule Failures and Integrity Risks</h3>
<p>More serious issues can arise from the use of out-of-date information than sending a warning letter a few seconds early. A good example of this class of weakness can be seen with <strong>trigger code</strong> used to enforce an integrity rule that is perhaps too complex to enforce with declarative referential integrity constraints. To illustrate, consider the following code, which uses a trigger to enforce a variation of a foreign key constraint, but one that enforces the relationship for only certain child table rows:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> DATABASE Sandpit</span><br><span class="line"><span class="keyword">SET</span> READ_COMMITTED_SNAPSHOT <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">ROLLBACK</span> IMMEDIATE;</span><br><span class="line">GO</span><br><span class="line"><span class="keyword">SET</span> TRANSACTION ISOLATION LEVEL READ COMMITTED;</span><br><span class="line">GO</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dbo.Parent (ParentID <span class="type">integer</span> <span class="keyword">PRIMARY</span> KEY);</span><br><span class="line">GO</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dbo.Child</span><br><span class="line">(</span><br><span class="line">    ChildID <span class="type">integer</span> <span class="keyword">IDENTITY</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    ParentID <span class="type">integer</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    CheckMe bit <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">);</span><br><span class="line">GO</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> dbo.Child_AI</span><br><span class="line"><span class="keyword">ON</span> dbo.Child</span><br><span class="line">AFTER <span class="keyword">INSERT</span></span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- Child rows with CheckMe = true</span></span><br><span class="line">    <span class="comment">-- must have an associated parent row</span></span><br><span class="line">    IF <span class="keyword">EXISTS</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span> ins.ParentID</span><br><span class="line">        <span class="keyword">FROM</span> inserted <span class="keyword">AS</span> ins</span><br><span class="line">        <span class="keyword">WHERE</span> ins.CheckMe <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">EXCEPT</span></span><br><span class="line">        <span class="keyword">SELECT</span> P.ParentID</span><br><span class="line">        <span class="keyword">FROM</span> dbo.Parent <span class="keyword">AS</span> P</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">    	RAISERROR (<span class="string">&#x27;Integrity violation!&#x27;</span>, <span class="number">16</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">ROLLBACK</span> TRANSACTION;</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">GO</span><br><span class="line"><span class="comment">-- Insert parent row #1</span></span><br><span class="line"><span class="keyword">INSERT</span> dbo.Parent (ParentID) <span class="keyword">VALUES</span> (<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>Now consider a transaction running in another session (use another SSMS window for this if you are following along) which deletes parent row #1, but does not commit yet:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> TRANSACTION ISOLATION LEVEL READ COMMITTED;</span><br><span class="line"><span class="keyword">BEGIN</span> TRANSACTION;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> dbo.Parent</span><br><span class="line"><span class="keyword">WHERE</span> ParentID <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>Back in our original session, we try to insert a (checked) child row that references this parent:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> dbo.Child (ParentID, CheckMe)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>The the trigger code executes, but because RCSI sees only <strong>committed</strong> data as of the time the statement started, it still sees the parent row (not the uncommitted deletion) and the <strong>insert succeeds</strong>!</p>
<p>The transaction that deleted the parent row can now commit its change successfully, leaving the database in an <strong>inconsistent</strong> state in terms of our trigger logic:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COMMIT</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> P.<span class="operator">*</span> <span class="keyword">FROM</span> dbo.Parent <span class="keyword">AS</span> P;</span><br><span class="line"><span class="keyword">SELECT</span> C.<span class="operator">*</span> <span class="keyword">FROM</span> dbo.Child <span class="keyword">AS</span> C;</span><br></pre></td></tr></table></figure>
<p><img src="/assets/read-committed-snapshot-isolation/1.png" alt="Integrity violation" title="Integrity violation"></p>
<p>This is a simplified example of course, and one which could easily be circumvented using the built-in constraint facilities. Much more complex business rules and pseudo-integrity constraints can be written inside and <strong>outside of triggers</strong>. The potential for incorrect behaviour under RCSI should be obvious.</p>
<h3 id="Blocking-behaviour-and-latest-committed-data"><a class="header-anchor" href="#Blocking-behaviour-and-latest-committed-data"></a>Blocking behaviour and latest-committed data</h3>
<p>I mentioned earlier that T-SQL code is not guaranteed to behave in the same way under RCSI read committed as it did using the locking implementation. The preceding trigger code example is a good illustration of that, but I need to emphasise that <strong>the general problem is not limited to triggers</strong>.</p>
<p>RCSI is typically not a good choice for any T-SQL code whose correctness depends on blocking if a concurrent uncommitted change exists. RCSI might also not be the right choice if the code depends on reading <strong>current</strong> committed data, rather than the latest committed data as at the time the statement started. These two considerations are related, but they are not the same thing.</p>
<h3 id="Locking-read-committed-under-RCSI"><a class="header-anchor" href="#Locking-read-committed-under-RCSI"></a>Locking read committed under RCSI</h3>
<p>SQL Server provides one way to request <strong>locking</strong> read committed when RCSI is enabled, using the table hint <code>READCOMMITTEDLOCK</code>. We can modify our trigger to avoid the problems shown above by adding this hint to the table that needs blocking behaviour to perform correctly:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TRIGGER</span> dbo.Child_AI</span><br><span class="line"><span class="keyword">ON</span> dbo.Child</span><br><span class="line">AFTER <span class="keyword">INSERT</span></span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- Child rows with CheckMe = true</span></span><br><span class="line">    <span class="comment">-- must have an associated parent row</span></span><br><span class="line">    IF <span class="keyword">EXISTS</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span> ins.ParentID</span><br><span class="line">        <span class="keyword">FROM</span> inserted <span class="keyword">AS</span> ins</span><br><span class="line">        <span class="keyword">WHERE</span> ins.CheckMe <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">EXCEPT</span></span><br><span class="line">        <span class="keyword">SELECT</span> P.ParentID</span><br><span class="line">        <span class="keyword">FROM</span> dbo.Parent <span class="keyword">AS</span> P <span class="keyword">WITH</span> (READCOMMITTEDLOCK) <span class="comment">-- NEW!!</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        RAISERROR (<span class="string">&#x27;Integrity violation!&#x27;</span>, <span class="number">16</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">ROLLBACK</span> TRANSACTION;</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>
<p>With this change in place, the attempt to insert the potentially-orphaned child row blocks until the deleting transaction commits (or aborts). If the delete commits, the trigger code detects the integrity violation and raises the expected error.</p>
<p>Identifying queries that <strong>might not perform correctly</strong> under RCSI is a non-trivial task that may require <strong>extensive testing</strong> to get right (and please remember these issues are quite general and not confined to trigger code!) Also, adding the <code>READCOMMITTEDLOCK</code> hint to every table that needs it can be a tedious and error-prone process. Until SQL Server provides a more broadly-scoped option to request the locking implementation where needed, we are stuck with using the table hints.</p>
<h3 id="Next-Time"><a class="header-anchor" href="#Next-Time"></a>Next Time</h3>
<p><a target="_blank" rel="noopener" href="https://sqlperformance.com/2014/05/t-sql-queries/data-modifications-under-rcsi">The next post in this series</a> continues our examination of read committed snapshot isolation, with a look at the surprising behaviour of data modification statements under RCSI.</p>
<p>[ <a target="_blank" rel="noopener" href="https://sqlperformance.com/2014/07/t-sql-queries/isolation-levels">See the index for the whole series</a> ]</p>
<hr>
<p><strong>本文地址：<a href="http://xnerv.wang/read-committed-snapshot-isolation/">http://xnerv.wang/read-committed-snapshot-isolation/</a></strong><br>
转载自：<a target="_blank" rel="noopener" href="https://sqlperformance.com/2014/05/t-sql-queries/read-committed-snapshot-isolation">Read Committed Snapshot Isolation</a></p>

    </div>

    
    
    <div class="post-widgets">
    <div
      class="social-share"
      
        data-sites="weibo,qq,wechat,tencent,douban,qzone,linkedin,diandian,facebook,twitter,google"
      
      
        data-wechat-qrcode-title="分享这篇文章"
      
      
        data-wechat-qrcode-helper="请扫描二维码"
      
    >
    </div>
  </div>
  <script src="//cdn.jsdelivr.net/npm/social-share.js@1/dist/js/social-share.min.js"></script>

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag"># 转载</a>
              <a href="/tags/DBMS/" rel="tag"># DBMS</a>
              <a href="/tags/SQL-Server/" rel="tag"># SQL Server</a>
              <a href="/tags/Transaction/" rel="tag"># Transaction</a>
              <a href="/tags/Isolation-Level/" rel="tag"># Isolation Level</a>
          </div>

        

      </footer>
    
  </article>
  
  
  

  </div>

  <!--hr/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- xnerv.wang bottom ad -->
    <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-5173793122443057"
        data-ad-slot="1774750366"
        data-ad-format="auto"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  <hr/-->


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Logical-Guarantees"><span class="nav-text">Logical Guarantees</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#A-point-in-time-view-of-committed-data"><span class="nav-text">A point-in-time view of committed data</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#The-implications-of-a-point-in-time-view"><span class="nav-text">The implications of a point-in-time view</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Non-repeatable-reads-and-phantoms"><span class="nav-text">Non-repeatable reads and phantoms</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Out-of-date-data"><span class="nav-text">Out-of-date data</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#A-question-of-timing"><span class="nav-text">A question of timing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Business-Rule-Failures-and-Integrity-Risks"><span class="nav-text">Business Rule Failures and Integrity Risks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Blocking-behaviour-and-latest-committed-data"><span class="nav-text">Blocking behaviour and latest-committed data</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Locking-read-committed-under-RCSI"><span class="nav-text">Locking read committed under RCSI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Next-Time"><span class="nav-text">Next Time</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Xnerv Wang (xnervwang)"
      src="/portraits/nerv.png">
  <p class="site-author-name" itemprop="name">Xnerv Wang (xnervwang)</p>
  <div class="site-description" itemprop="description">Xnerv Wang (xnervwang) 的技术博客，主要涉及C/C++、数据库引擎开发、文件系统、TCP/IP与网络、分布式系统和Linux等领域，也会偶尔刷一刷LeetCode等题库。毕业于南京大学软件学院，曾经在腾讯、百度、微软上海等大型互联网企业工作，目前奋斗在微软西雅图，从事Azure上的MySQL/PostgreSQL开源数据库云服务开发。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">122</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">167</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2008 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-eye"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xnerv Wang (xnervwang)</span>
</div>

<div>
  <span>God's in his heaven. All's right with the world.</span>
</div>

        








  <script>
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=60335024";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  <script>
    var _mtac = {};
    (function() {
      var mta = document.createElement("script");
      mta.src = "https://pingjs.qq.com/h5/stats.js";
      mta.setAttribute("name", "MTAH5");
      mta.setAttribute("sid", "60335024");
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(mta, s);
    })();
  </script>


        
      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  
<script src="/js/local-search.js"></script>














  

  

  


  <!-- baidu tuijian -->
  <div id="hm_t_123"></div>
</body>
</html>
