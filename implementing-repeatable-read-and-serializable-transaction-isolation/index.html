<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="XNERV SURVEYS" type="application/atom+xml">
  <meta name="google-site-verification" content="google819a2e66056c8144">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: 'VK1UJWKNY9',
      apiKey: '7b99451966536b0cd610a773068159a0',
      indexName: 'xnerv.wang',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="This article is part of a series. You do not have to read them in order but I will be referring to topics and explanations in previous articles:  Implementing Your Own Transactions With MVCC SQL Trans">
<meta property="og:type" content="article">
<meta property="og:title" content="IMPLEMENTING REPEATABLE READ AND SERIALIZABLE TRANSACTION ISOLATION（转载）">
<meta property="og:url" content="https://xnerv.wang/implementing-repeatable-read-and-serializable-transaction-isolation/index.html">
<meta property="og:site_name" content="XNERV SURVEYS">
<meta property="og:description" content="This article is part of a series. You do not have to read them in order but I will be referring to topics and explanations in previous articles:  Implementing Your Own Transactions With MVCC SQL Trans">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2018-01-30T06:33:00.000Z">
<meta property="article:modified_time" content="2025-03-10T00:30:07.006Z">
<meta property="article:author" content="Xnerv Wang (xnervwang)">
<meta property="article:tag" content="转载">
<meta property="article:tag" content="DBMS">
<meta property="article:tag" content="SQL Server">
<meta property="article:tag" content="Transaction">
<meta property="article:tag" content="Isolation Level">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://xnerv.wang/implementing-repeatable-read-and-serializable-transaction-isolation/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/social-share.js@1/dist/js/social-share.min.css">
  <title>IMPLEMENTING REPEATABLE READ AND SERIALIZABLE TRANSACTION ISOLATION（转载） | XNERV SURVEYS</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90038341-1"></script>
    <script>
      var host = window.location.hostname;
      if (host !== "localhost" || !true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-90038341-1');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?fa4c42961138739a56782aee8127449f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <!--a href="https://github.com/xnervwang" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="/assets/forkme.png" alt="Fork me on GitHub" data-canonical-src="/assets/forkme_right_darkblue.png"></a-->
    <a target="_blank" rel="noopener" href="https://github.com/xnervwang" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">XNERV SURVEYS</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">God's in his heaven.<br/>All's right with the world.</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xnerv.wang/implementing-repeatable-read-and-serializable-transaction-isolation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/portraits/nerv.png">
      <meta itemprop="name" content="Xnerv Wang (xnervwang)">
      <meta itemprop="description" content="Xnerv Wang (xnervwang) 的技术博客，主要涉及C/C++、数据库引擎开发、文件系统、TCP/IP与网络、分布式系统和Linux等领域，也会偶尔刷一刷LeetCode等题库。毕业于南京大学软件学院，曾经在腾讯、百度、微软上海等大型互联网企业工作，目前奋斗在微软西雅图，从事Azure上的MySQL/PostgreSQL开源数据库云服务开发。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XNERV SURVEYS">
    </span>
      <header class="post-header">

        <h2 class="post-title" itemprop="name headline">
          IMPLEMENTING REPEATABLE READ AND SERIALIZABLE TRANSACTION ISOLATION（转载）
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-01-29 22:33:00" itemprop="dateCreated datePublished" datetime="2018-01-29T22:33:00-08:00">2018-01-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DBMS/" itemprop="url" rel="index">
                    <span itemprop="name">DBMS</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>This article is part of a series. You do not have to read them in order but I will be referring to topics and explanations in previous articles:</p>
<ol>
<li><a href="/implementing-your-own-transactions-with-mvcc">Implementing Your Own Transactions With MVCC</a></li>
<li><a href="/sql-transaction-isolation-levels-explained">SQL Transaction Isolation Levels Explained</a></li>
<li><strong>Implementing Repeatable Read and Serializable Transaction Isolation</strong></li>
</ol>
<span id="more"></span>
<hr>
<p><em>Repeatable read</em> and <em>serializable</em> are usually higher than most databases use by default (if they are available at all). You can read a full explanation of the differences in the levels in the previous article, <a target="_blank" rel="noopener" href="http://elliot.land/post/sql-transaction-isolation-levels-explained">SQL Transaction Isolation Levels Explained</a>.</p>
<p>This article will focus on a real Python implementation of all four levels but mainly focused on repeatable read and serializable.</p>
<p>I’m going to use the code from the <a target="_blank" rel="noopener" href="https://elliot.land/post/implementing-your-own-transactions-with-mvcc">original article on MVCC which implemented read-committed</a> and refactor it to allow us to set the transaction isolation. You should understand how MVCC works an how it is implemented for <em>read committed</em> in that article before proceeding.</p>
<p>You can view the <a target="_blank" rel="noopener" href="https://gist.github.com/elliotchance/21e31b8ffb18cbbca23b8031639e1c3f">entire program here</a>.</p>
<h2 id="Implementing-the-Isolation-Levels-as-Classes"><a class="header-anchor" href="#Implementing-the-Isolation-Levels-as-Classes"></a>Implementing the Isolation Levels as Classes</h2>
<p>The majority of the logic of a transaction will remain in the Transaction class. There have been some new methods added:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Transaction</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, table, xid</span>):</span><br><span class="line">        self.table = table</span><br><span class="line">        self.xid = xid</span><br><span class="line">        self.rollback_actions = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_record</span>(<span class="params">self, <span class="built_in">id</span>, name</span>):</span><br><span class="line">        record = &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: <span class="built_in">id</span>,</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: name,</span><br><span class="line">            <span class="string">&#x27;created_xid&#x27;</span>: self.xid,</span><br><span class="line">            <span class="string">&#x27;expired_xid&#x27;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        self.rollback_actions.append([<span class="string">&quot;delete&quot;</span>, <span class="built_in">len</span>(self.table.records)])</span><br><span class="line">        self.table.records.append(record)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_record</span>(<span class="params">self, <span class="built_in">id</span></span>):</span><br><span class="line">        <span class="keyword">for</span> i, record <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.table.records):</span><br><span class="line">            <span class="keyword">if</span> self.record_is_visible(record) <span class="keyword">and</span> record[<span class="string">&#x27;id&#x27;</span>] == <span class="built_in">id</span>:</span><br><span class="line">                <span class="keyword">if</span> self.record_is_locked(record):</span><br><span class="line">                    <span class="keyword">raise</span> RollbackException(<span class="string">&quot;Row locked by another transaction.&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    record[<span class="string">&#x27;expired_xid&#x27;</span>] = self.xid</span><br><span class="line">                    self.rollback_actions.append([<span class="string">&quot;add&quot;</span>, i])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_record</span>(<span class="params">self, <span class="built_in">id</span>, name</span>):</span><br><span class="line">        self.delete_record(<span class="built_in">id</span>)</span><br><span class="line">        self.add_record(<span class="built_in">id</span>, name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fetch_record</span>(<span class="params">self, <span class="built_in">id</span></span>):</span><br><span class="line">        <span class="keyword">for</span> record <span class="keyword">in</span> self.table.records:</span><br><span class="line">            <span class="keyword">if</span> self.record_is_visible(record) <span class="keyword">and</span> record[<span class="string">&#x27;id&#x27;</span>] <span class="keyword">is</span> <span class="built_in">id</span>:</span><br><span class="line">                <span class="keyword">return</span> record</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">count_records</span>(<span class="params">self, min_id, max_id</span>):</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> record <span class="keyword">in</span> self.table.records:</span><br><span class="line">            <span class="keyword">if</span> self.record_is_visible(record) <span class="keyword">and</span> \</span><br><span class="line">                min_id &lt;= record[<span class="string">&#x27;id&#x27;</span>] &lt;= max_id:</span><br><span class="line">                count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fetch_all_records</span>(<span class="params">self</span>):</span><br><span class="line">        visible_records = []</span><br><span class="line">        <span class="keyword">for</span> record <span class="keyword">in</span> self.table.records:</span><br><span class="line">            <span class="keyword">if</span> self.record_is_visible(record):</span><br><span class="line">                visible_records.append(record)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> visible_records</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fetch</span>(<span class="params">self, expr</span>):</span><br><span class="line">        visible_records = []</span><br><span class="line">        <span class="keyword">for</span> record <span class="keyword">in</span> self.table.records:</span><br><span class="line">            <span class="keyword">if</span> self.record_is_visible(record) <span class="keyword">and</span> expr(record):</span><br><span class="line">                visible_records.append(record)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> visible_records</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">commit</span>(<span class="params">self</span>):</span><br><span class="line">        self.table.active_xids.discard(self.xid)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rollback</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> action <span class="keyword">in</span> <span class="built_in">reversed</span>(self.rollback_actions):</span><br><span class="line">            <span class="keyword">if</span> action[<span class="number">0</span>] == <span class="string">&#x27;add&#x27;</span>:</span><br><span class="line">                self.table.records[action[<span class="number">1</span>]][<span class="string">&#x27;expired_xid&#x27;</span>] = <span class="number">0</span></span><br><span class="line">            <span class="keyword">elif</span> action[<span class="number">0</span>] == <span class="string">&#x27;delete&#x27;</span>:</span><br><span class="line">                self.table.records[action[<span class="number">1</span>]][<span class="string">&#x27;expired_xid&#x27;</span>] = self.xid</span><br><span class="line"></span><br><span class="line">        self.table.active_xids.discard(self.xid)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<p>We also introduce a new type of error, the RollbackException. We will use this to indicate that some race condition has occurred, that if allowed to continue would break the requirements of the chosen isolation level. This type of error becomes more common as the isolation level increases and is caught by the DBMS so that the transaction can be safely rolled back and the client notified.</p>
<p>It is really just an alias for Exception. However, we want to differentiate this type of error so that other errors are not mistakenly caught:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RollbackException</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<p>It’s not easy to demonstrate interfaces or abstract classes in Python. Two methods that are missing from the Transaction class above are record_is_locked(record) and record_is_visible(record) and are implemented by the child class. As long as we implement these two methods we can control the isolation behaviour of the transaction.</p>
<p>For example the most simple isolation level is <em>read uncommitted</em>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReadUncommittedTransaction</span>(<span class="title class_ inherited__">Transaction</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_is_locked</span>(<span class="params">self, record</span>):</span><br><span class="line">        <span class="keyword">return</span> record[<span class="string">&#x27;expired_xid&#x27;</span>] != <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_is_visible</span>(<span class="params">self, record</span>):</span><br><span class="line">        <span class="keyword">return</span> record[<span class="string">&#x27;expired_xid&#x27;</span>] == <span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>It may seem like an anti-transaction pattern to read data that is not yet confirmed by another transaction. Read uncommitted is useful for large reporting queries where you really don’t want to impose any locking that would affect in-flight or new transactions. In exchange for this your totals may be a little off. Sometimes this is insignificant enough (such as processing millions of rows) that it makes sense to trade accuracy for concurrency.</p>
<hr>
<p>Here is the implementation for <em>read committed</em> (if you have read the previous article this should look very familiar):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReadCommittedTransaction</span>(<span class="title class_ inherited__">Transaction</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_is_locked</span>(<span class="params">self, record</span>):</span><br><span class="line">        <span class="keyword">return</span> record[<span class="string">&#x27;expired_xid&#x27;</span>] != <span class="number">0</span> <span class="keyword">and</span> \</span><br><span class="line">            row[<span class="string">&#x27;expired_xid&#x27;</span>] <span class="keyword">in</span> self.table.active_xids</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_is_visible</span>(<span class="params">self, record</span>):</span><br><span class="line">        <span class="comment"># The record was created in active transaction that is not our</span></span><br><span class="line">        <span class="comment"># own.</span></span><br><span class="line">        <span class="keyword">if</span> record[<span class="string">&#x27;created_xid&#x27;</span>] <span class="keyword">in</span> self.table.active_xids <span class="keyword">and</span> \</span><br><span class="line">            record[<span class="string">&#x27;created_xid&#x27;</span>] != self.xid:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># The record is expired or and no transaction holds it that is</span></span><br><span class="line">        <span class="comment"># our own.</span></span><br><span class="line">        <span class="keyword">if</span> record[<span class="string">&#x27;expired_xid&#x27;</span>] != <span class="number">0</span> <span class="keyword">and</span> \</span><br><span class="line">            (record[<span class="string">&#x27;expired_xid&#x27;</span>] <span class="keyword">not</span> <span class="keyword">in</span> self.table.active_xids <span class="keyword">or</span> \</span><br><span class="line">            record[<span class="string">&#x27;expired_xid&#x27;</span>] == self.xid):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>I won’t explain this now as there was already a whole article dedicated to it.</p>
<hr>
<p>Now we can move onto the higher isolation levels that most databases do not use by default because concurrency and performance start to suffer in exchange for greater accuracy and isolations of the transactions:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RepeatableReadTransaction</span>(<span class="title class_ inherited__">ReadCommittedTransaction</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_is_locked</span>(<span class="params">self, record</span>):</span><br><span class="line">        <span class="keyword">return</span> ReadCommittedTransaction.record_is_locked(self, record) <span class="keyword">or</span> \</span><br><span class="line">            self.table.locks.exists(self, record[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_is_visible</span>(<span class="params">self, record</span>):</span><br><span class="line">        is_visible = ReadCommittedTransaction.record_is_visible(self, record)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> is_visible:</span><br><span class="line">            self.table.locks.add(self, record[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> is_visible</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>To achieve repeatable read we use the same visibility (and locking) checks as read committed (ReadCommittedTransaction), but we add a read lock on every record that is read (and hence, visible) by us. It’s important we don’t add read locks to records that would otherwise not be visible to us, so that another transaction cannot remove it if we need to rescan the data.</p>
<p>Here is a very crude lock manager, it simply keeps track of which transactions hold a read lock on any particular row. How this lock manager performs isn’t important, and there many ways to make this mechanism work better and faster. For the purpose of this demonstration just know that there is <em>something</em> that remembers when transactions have <em>seen</em> a row:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LockManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.locks = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, transaction, record_id</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.exists(transaction, record_id):</span><br><span class="line">            self.locks.append([transaction, record_id])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">exists</span>(<span class="params">self, transaction, record_id</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">any</span>(lock[<span class="number">0</span>] <span class="keyword">is</span> transaction <span class="keyword">and</span> lock[<span class="number">1</span>] == record_id \</span><br><span class="line">            <span class="keyword">for</span> lock <span class="keyword">in</span> self.locks)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<p>Finally, we can implement <em>serializable</em>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SerializableTransaction</span>(<span class="title class_ inherited__">RepeatableReadTransaction</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, table, xid</span>):</span><br><span class="line">        Transaction.__init__(self, table, xid)</span><br><span class="line">        self.existing_xids = self.table.active_xids.copy()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_is_visible</span>(<span class="params">self, record</span>):</span><br><span class="line">        is_visible = ReadCommittedTransaction.record_is_visible(self, record) \</span><br><span class="line">            <span class="keyword">and</span> record[<span class="string">&#x27;created_xid&#x27;</span>] &lt;= self.xid \</span><br><span class="line">            <span class="keyword">and</span> record[<span class="string">&#x27;created_xid&#x27;</span>] <span class="keyword">in</span> self.existing_xids</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> is_visible:</span><br><span class="line">            self.table.locks.add(self, record[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> is_visible</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Once again it uses the logic of ReadCommittedTransaction (but not RepeatableReadTransaction as you might originally suspect). Serializable primarily enforces one main new restriction to prevent phantom reads. That is, we must ignore any record that is added or updated in a transaction that was created after the current transaction.</p>
<p><strong>Bring On the Tests</strong></p>
<p>To really demonstrate the isolation levels we need to create test cases. All of the tests start with the same fixture data:</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Joe</td>
</tr>
<tr>
<td>3</td>
<td>Jill</td>
</tr>
</tbody>
</table>
<p>A transaction test is implemented as a class. It will setup the fixture data (in the table above) and clients on which the test will be performed. It also runs the test and returns a pretty tick or cross for the outcome (we will use this later).</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TransactionTest</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, transaction_type</span>):</span><br><span class="line">        self.table = Table()</span><br><span class="line">        client = self.table.new_transaction(ReadCommittedTransaction)</span><br><span class="line">        client.add_record(<span class="built_in">id</span>=<span class="number">1</span>, name=<span class="string">&quot;Joe&quot;</span>)</span><br><span class="line">        client.add_record(<span class="built_in">id</span>=<span class="number">3</span>, name=<span class="string">&quot;Jill&quot;</span>)</span><br><span class="line">        client.commit()</span><br><span class="line"></span><br><span class="line">        self.client1 = self.table.new_transaction(transaction_type)</span><br><span class="line">        self.client2 = self.table.new_transaction(transaction_type)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_test</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self.run()</span><br><span class="line">        <span class="keyword">except</span> RollbackException:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">result</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self.run_test():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">u&#x27;✔&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">u&#x27;✘&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Individual error scenarios (dirty reads, non-repeatable reads and phantom reads) are implemented by extending the TransactionTest and providing the run() method:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DirtyRead</span>(<span class="title class_ inherited__">TransactionTest</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        result1 = self.client1.fetch_record(<span class="built_in">id</span>=<span class="number">1</span>)</span><br><span class="line">        self.client2.update_record(<span class="built_in">id</span>=<span class="number">1</span>, name=<span class="string">&quot;Joe 2&quot;</span>)</span><br><span class="line">        result2 = self.client1.fetch_record(<span class="built_in">id</span>=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result1 != result2</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NonRepeatableRead</span>(<span class="title class_ inherited__">TransactionTest</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        result1 = self.client1.fetch_record(<span class="built_in">id</span>=<span class="number">1</span>)</span><br><span class="line">        self.client2.update_record(<span class="built_in">id</span>=<span class="number">1</span>, name=<span class="string">&quot;Joe 2&quot;</span>)</span><br><span class="line">        self.client2.commit()</span><br><span class="line">        result2 = self.client1.fetch_record(<span class="built_in">id</span>=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result1 != result2</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PhantomRead</span>(<span class="title class_ inherited__">TransactionTest</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        result1 = <span class="built_in">len</span>(self.client1.fetch(<span class="keyword">lambda</span> r: <span class="number">1</span> &lt;= r[<span class="string">&#x27;id&#x27;</span>] &lt;= <span class="number">3</span>))</span><br><span class="line">        self.client2.add_record(<span class="built_in">id</span>=<span class="number">2</span>, name=<span class="string">&quot;John&quot;</span>)</span><br><span class="line">        self.client2.commit()</span><br><span class="line">        result2 = self.client1.count_records(min_id=<span class="number">1</span>, max_id=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result1 != result2</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Running the <a target="_blank" rel="noopener" href="https://gist.github.com/elliotchance/21e31b8ffb18cbbca23b8031639e1c3f">complete program</a> prints a table of results. The <font style="font-family: 'Courier New';">✔ means that it could replicate that kind of error (a little counterintuitive, I know):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">                  Dirty Repeat Phantom</span><br><span class="line">read uncommitted    ✔      ✔      ✔</span><br><span class="line">read committed      ✘      ✔      ✔</span><br><span class="line">repeatable read     ✘      ✘      ✔</span><br><span class="line">serializable        ✘      ✘      ✘</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<p><strong>本文地址：<a href="https://xnerv.wang/implementing-repeatable-read-and-serializable-transaction-isolation/">https://xnerv.wang/implementing-repeatable-read-and-serializable-transaction-isolation/</a></strong><br>
转载自：<a target="_blank" rel="noopener" href="http://elliot.land/post/implementing-repeatable-read-and-serializable-transaction-isolation">IMPLEMENTING REPEATABLE READ AND SERIALIZABLE TRANSACTION ISOLATION</a></p>

    </div>

    
    
    <div class="post-widgets">
    <div
      class="social-share"
      
        data-sites="weibo,qq,wechat,tencent,douban,qzone,linkedin,diandian,facebook,twitter,google"
      
      
        data-wechat-qrcode-title="分享这篇文章"
      
      
        data-wechat-qrcode-helper="请扫描二维码"
      
    >
    </div>
  </div>
  <script src="//cdn.jsdelivr.net/npm/social-share.js@1/dist/js/social-share.min.js"></script>

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag"># 转载</a>
              <a href="/tags/DBMS/" rel="tag"># DBMS</a>
              <a href="/tags/SQL-Server/" rel="tag"># SQL Server</a>
              <a href="/tags/Transaction/" rel="tag"># Transaction</a>
              <a href="/tags/Isolation-Level/" rel="tag"># Isolation Level</a>
          </div>

        

      </footer>
    
  </article>
  
  
  

  </div>

  <!--hr/>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- xnerv.wang bottom ad -->
    <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-5173793122443057"
        data-ad-slot="1774750366"
        data-ad-format="auto"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  <hr/-->


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Implementing-the-Isolation-Levels-as-Classes"><span class="nav-text">Implementing the Isolation Levels as Classes</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Xnerv Wang (xnervwang)"
      src="/portraits/nerv.png">
  <p class="site-author-name" itemprop="name">Xnerv Wang (xnervwang)</p>
  <div class="site-description" itemprop="description">Xnerv Wang (xnervwang) 的技术博客，主要涉及C/C++、数据库引擎开发、文件系统、TCP/IP与网络、分布式系统和Linux等领域，也会偶尔刷一刷LeetCode等题库。毕业于南京大学软件学院，曾经在腾讯、百度、微软上海等大型互联网企业工作，目前奋斗在微软西雅图，从事Azure上的MySQL/PostgreSQL开源数据库云服务开发。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">122</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">167</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2008 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-eye"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xnerv Wang (xnervwang)</span>
</div>

<div>
  <span>God's in his heaven. All's right with the world.</span>
</div>

        








  <script>
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=60335024";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  <script>
    var _mtac = {};
    (function() {
      var mta = document.createElement("script");
      mta.src = "https://pingjs.qq.com/h5/stats.js";
      mta.setAttribute("name", "MTAH5");
      mta.setAttribute("sid", "60335024");
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(mta, s);
    })();
  </script>


        
      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  
<script src="/js/local-search.js"></script>














  

  

  


  <!-- baidu tuijian -->
  <div id="hm_t_123"></div>
</body>
</html>
